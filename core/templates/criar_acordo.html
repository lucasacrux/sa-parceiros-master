<!DOCTYPE html>
{% extends "base.html" %}

{% load static %}

{% block content %}
<!-- ========== MAIN CONTENT ========== -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<style>
  .flatpickr-calendar .flatpickr-day.today {
    background-color: #377dff30 !important;
    color: #1e2022 !important;
    border-color: transparent !important;
  }

  .select2-container {
    width: 100% !important;
  }

  .select2-container .select2-selection--multiple {
    min-height: 36px !important;
  }

  .select2-container--default .select2-selection--multiple {
    background-color: #FFFFFF !important;
    border: .0625rem solid rgba(231, 234, 243, .7) !important;
    border-radius: .3125rem !important;
  }

  .select2-container--default.select2-container--focus .select2-selection--multiple {
    border: solid #418AE9 1px !important;
    outline: 0 !important;
  }

  .select2-container--default .select2-selection--multiple .select2-selection__choice__display {
    padding-left: 20px !important;
  }

  .select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #FFFFFF !important;
    border: 1px solid #1366ff !important;
    margin-top: 9px !important;
  }

  .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
    color: #1e2022 !important;
  }

  .select2-container--default .select2-selection--multiple .select2-selection__choice__display {
    color: #1e2022 !important;
  }

  .select2-container .select2-container--default .select2-container--open {
    top: 293px !important;
  }

  .select2-container .select2-search--inline {
    margin-top: -16px !important;
    margin-left: 8px !important;
  }

  .ant-select {
    position: absolute;
    width: 100%;
    height: 45px !important;
    z-index: 999;
    background-color: transparent;
  }

  @media (max-width: 768px) {
    .ant-select {
      height: 230px !important;
    }
  }
</style>

<main id="content" role="main" class="main">
    <div class="content container-fluid">
      <!-- Step Form -->
      <form class="js-step-form py-md-5" method="POST" data-hs-step-form-options="{
              &quot;progressSelector&quot;: &quot;#addUserStepFormProgress&quot;,
              &quot;stepsSelector&quot;: &quot;#addUserStepFormContent&quot;,
              &quot;endSelector&quot;: &quot;#addUserFinishBtn&quot;,
              &quot;isValidate&quot;: false
            }">
        {% csrf_token %}

        <input type="hidden" name="acordo_data" value="{{ acordo_data }}">

        <div class="row justify-content-lg-center">
          <div class="col-lg-8" style="position: relative;">
            <div class="col-lg-8 ant-select"></div>
            <!-- Step -->
            <ul id="addUserStepFormProgress" class="js-step-progress step step-sm step-icon-sm step step-inline step-item-between mb-3 mb-md-5">
              <li class="step-item active focus">
                <a class="step-content-wrapper" href="javascript:;" data-hs-step-form-next-options="{
                    &quot;targetSelector&quot;: &quot;#addUserStepProfile&quot;
                  }">
                  <span class="step-icon step-icon-soft-dark">1</span>
                  <div class="step-content">
                    <span class="step-title">CPF</span>
                  </div>
                </a>
              </li>

              <li class="step-item">
                <a class="step-content-wrapper" href="javascript:;" data-hs-step-form-next-options="{
                    &quot;targetSelector&quot;: &quot;#addUserStepBillingAddress&quot;
                  }">
                  <span class="step-icon step-icon-soft-dark">2</span>
                  <div class="step-content">
                    <span class="step-title">Contratos</span>
                  </div>
                </a>
              </li>

              <li class="step-item">
                <a class="step-content-wrapper" href="javascript:;" data-hs-step-form-next-options="{
                    &quot;targetSelector&quot;: &quot;#addUserStepConfirmation&quot;
                  }">
                  <span class="step-icon step-icon-soft-dark">3</span>
                  <div class="step-content">
                    <span class="step-title">Criar acordo</span>
                  </div>
                </a>
              </li>
            </ul>
            <!-- End Step -->

            <!-- Content Step Form -->
            <div id="addUserStepFormContent">
              <div id="addUserStepProfile" class="card card-lg active" style="display: block; opacity: 1.0325;">
                <div class="card-body">
                  <!-- Form -->
                  <div class="row mb-4">
                    <label for="emailLabel" class="col-sm-3 col-form-label form-label">CPF:</label>
                    <div class="col-sm-9">
                      <input type="text" class="js-input-mask form-control" name="cpf" data-name="cpf" placeholder="xxx.xxx.xxx-xx" aria-label="xxx.xxx.xxx-xx" data-hs-mask-options='{
                        "mask": "000.000.000-00"
                      }'>
                      <small id="cpfError" class="form-text text-danger" style="display:none;">CPF não encontrado ou inválido.</small>
                    </div>
                  </div>
                  <!-- End Form -->
                </div>
                <!-- Footer -->
                <div class="card-footer d-flex justify-content-end align-items-center">
                  <button id="nextButton" type="button" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    Proximo <i class="bi-chevron-right"></i>
                  </button>
                </div>
                <!-- End Footer -->
              </div>

              <div id="addUserStepBillingAddress" class="card card-lg" style="display: none; opacity: 1.02;">
                <div class="card-body">
                  <!-- Form -->
                  <div class="row mb-4">
                    <label for="locationLabel-ts-control" class="col-sm-3 col-form-label form-label" id="locationLabel-ts-label">Contratos:</label>
                    <div class="col-sm-9">
                      <div class="mb-4">
                        <!-- Select -->
                        <select id="contractSelect" class="form-control" name="contrato" multiple>
                          
                        </select>
                        <small id="contratosError" class="form-text text-danger" style="display:none;">Por favor, selecione ao menos um contrato para prosseguir.</small>
                        <!-- End Select -->
                      </div>
                    </div>
                  </div>
                  <!-- End Form -->
                </div>
                <!-- Footer -->
                <div class="card-footer d-flex align-items-center">
                  <button type="button" class="btn btn-ghost-secondary" data-hs-step-form-prev-options="{
                       &quot;targetSelector&quot;: &quot;#addUserStepProfile&quot;
                     }">
                    <i class="bi-chevron-left"></i> Voltar
                  </button>

                  <div class="ms-auto">
                    <button id="nextButton2" type="button" class="btn btn-primary">
                      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                      Proximo <i class="bi-chevron-right"></i>
                    </button>
                  </div>
                </div>
                <!-- End Footer -->
              </div>

              <div id="addUserStepConfirmation" class="card card-lg" style="display: none;">       
                <div class="card-body">

                  <div class="row mb-4">
                    <h2>Detalhes do contrato</h2>
                  </div>

                  <div class="row mb-4">
                  <!-- Table -->
                  <table class="table mb-5">
                    <tbody>
                      <tr>
                        <th scope="row"></th>
                        <td>
                          <div><strong>Nome do Cliente: </strong><span id="pessoaNome"></span></div>
                        </td>
                        <td>
                          <div><strong>CPF: </strong><span id="pessoaCpf"></span></div>
                        </td>
                        <td>
                          <div><strong>Contratos selecionados: </strong><span id="selectedContracts"></span></div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row"></th>
                        <td>
                          <div><strong>Valor pendente de amortização: </strong><span id="valorPendente"></span></div>
                        </td>
                        <td>
                          <div><strong>Nº minimo de parcelas: </strong><span id="minParcelas"></span></div>
                        </td>
                        <td>
                          <div><strong>Nº maximo de parcelas: </strong><span id="maxParcelas"></span></div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row"></th>
                        <td>
                          <div><strong style="color: green;">Maior desconto: </strong><span id="maiorDesconto"></span></div>
                        </td>
                        <td>
                          <div><strong style="color: red;">Menor desconto: </strong><span id="menorDesconto"></span></div>
                        </td>
                        <td>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <!-- End Table -->
                  </div>

                  <div class="row mb-4">
                    <h2>Criação de acordo</h2>
                  </div>

                  <div class="row mb-4">
                    <label for="Valor_do_Acordo" class="col-sm-3 col-form-label form-label">Valor do acordo:</label>
                    <div class="col-sm-9">
                      <div class="col-sm-9">
                        <div class="input-group mb-3">
                          <span class="input-group-text">R$</span>
                          <input type="text" class="form-control" name="Valor_do_Acordo" id="Valor_do_Acordo">
                        </div>
                        <small id="valorAcordoError" class="form-text text-danger" style="display:none;">valor do acordo menor que o valor pendente de amortização.</small>
                      </div>        
                    </div>
                  </div>

                  <div class="row mb-4">
                    <label for="num_parcelas_acordo" class="col-sm-3 col-form-label form-label">Parcelas:</label>
                    <div class="col-sm-9">
                      <div class="input-group input-group-md-vertical" style="display: flex; align-items: center;">
                        <input type="text" class="form-control" id="parcelasInput" style="margin-right: 20px;">
                        <input type="range" class="form-range" id="customRange1" style="width: 75%;">
                      </div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <label for="valor_parcela" class="col-sm-3 col-form-label form-label">Valor parcela:</label>
                    <div class="col-sm-9">
                      <div class="input-group mb-3">
                        <span class="input-group-text">R$</span>
                        <input type="text" class="form-control" name="valor_parcela" id="valor_parcela" disabled>
                      </div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <label for="dia_vencimento_primeira_parcela" class="col-sm-3 col-form-label form-label">Vencimento primeira parcela:</label>
                    <div class="col-sm-9">
                      <div class="form-group">                          
                        <div id="projectDeadlineNewProjectFlatpickr" class="flatpickr-custom input-group">
                          <div class="input-group-prepend input-group-text" data-bs-toggle>
                            <i class="bi-calendar-week"></i>
                          </div>
                          <input type="text" name="dia_vencimento_primeira_parcela" class="form-control" id="primeiroVencimentoFlatpickrInput" placeholder="Selecione uma data">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <label for="dia_vencimento_proximas_parcelas" class="col-sm-3 col-form-label form-label">Vencimento próximas parcelas:</label>
                    <div class="col-sm-9">
                        <div class="form-group">                          
                            <select name="dia_vencimento_proximas_parcelas" class="form-control" id="proximovencimentoFlatpickrInput">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                    </div>
                </div>

                  <div class="row mb-4">
                    <label for="email" class="col-sm-3 col-form-label form-label">Email:</label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" name="email" id="email" placeholder="exemplo@saparceiros.com">
                    </div>
                  </div>

                  <div class="row mb-4">
                    <label for="telefone" class="col-sm-3 col-form-label form-label">Telefone:</label>
                    <div class="col-sm-9">
                      <input type="text" class="js-input-mask form-control" id="PhoneNumberLabel" placeholder="(xx) x xxxx-xxxx"
                      data-hs-mask-options='{
                        "mask": "(00) 0 0000-0000"
                      }'>
                    </div>
                  </div>

                  <div class="mt-5 mb-2" style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" id="preVisualizarAcordoBtn">Pré visualizar acordo</button>

                    <!-- Modal -->
                    <div class="modal modal-lg fade" id="previewAcordo" tabindex="-1" aria-labelledby="previewAcordoLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="previewAcordoLabel">Pré visualização do acordo</h5>
                            <button type="button" class="btn-close" id="simularAcordoBtn" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>

                          <div class="modal-body">
                            <!-- Table -->
                            <table class="table mb-5">
                              <tbody>
                                <tr>
                                  <th scope="row"></th>
                                  <td>
                                    <div>CPF: <span id="pessoaCpf2"></span></div>
                                  </td>
                                  <td>
                                    
                                  </td>
                                </tr>
                                <tr>
                                  <th scope="row"></th>
                                  <td>
                                    <div>Email: <span id="emailSpan"></span></div>
                                  </td>
                                  <td>
                                    <div>Telefone: <span id="telefoneSpan"></span></div>
                                  </td>
                                </tr>
                                <tr>
                                  <th scope="row"></th>
                                  <td>
                                    <div>Contratos selecionados: <span id="selectedContracts2"></span></div>
                                  </td>
                                  <td>
                                    <div>Valor acordo: <span id="valorAcordoSpan"></span></div>
                                  </td>
                                </tr>
                                <tr>
                                  <th scope="row"></th>
                                  <td>
                                    <div>Nº parcelas: <span id="numParcelasSpan"></span></div>
                                  </td>
                                  <td>
                                    <div>Valor Parcela: <span id="valorParcelaSpan"></span></div>
                                  </td>
                                </tr>
                                <tr>
                                  <th scope="row"></th>
                                  <td>
                                    <div>Venc Primeira Parc: <span id="vencPrimeiraParcelaSpan"></span></div>
                                  </td>
                                  <td>
                                    <div>Venc Próximas Parc: <span id="vencProximasParcelasSpan"></span></div>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                            <!-- End Table -->

                            <div class="accordion" id="accordionContrato">
                              <div class="accordion-item">
                                <div class="accordion-header" id="headingTwo">
                                  <a class="accordion-button collapsed" role="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Parcelas
                                  </a>
                                </div>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionContrato">
                                  <div class="accordion-body">
                                    <table class="table">
                                      <thead class="thead-light">
                                        <tr>
                                          <th scope="col">Nº parcela</th>
                                          <th scope="col">Valor parcela</th>
                                          <th scope="col">Data de vencimento</th>
                                        </tr>
                                      </thead>
                                      <tbody id="parcelasTBody">
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="modal-footer">
                              <button type="button" class="btn btn-white" data-bs-dismiss="modal">Cancelar</button>
                              <button type="button" class="btn btn-primary" id="aceitarAcordoBtn" data-bs-dismiss="modal">Aceitar Acordo</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    <!-- End Modal -->
                  </div>

                  <!-- Modal -->
                  <div class="modal modal-lg fade" id="previewBoletos" tabindex="-1" aria-labelledby="previewBoletosLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="previewBoletosLabel">Boletos</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                          <!-- Table -->
                          <table class="table">
                            <thead class="thead-light">
                              <tr>
                                <th scope="col">Nº parcela</th>
                                <th scope="col">Valor parcela</th>
                                <th scope="col">Data de vencimento</th>
                                <th scope="col">Data do pagamento</th>
                                <th scope="col">Situação Parcela</th>
                                <th scope="col">Boleto</th>
                              </tr>
                            </thead>
                            <tbody id="parcelasBoleto">
                            </tbody>
                          </table>
                          <!-- End Table -->
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- End Modal -->
                  </div>

                  <!-- Footer -->
                  <div class="card-footer d-sm-flex align-items-sm-center">
                    <button type="button" class="btn btn-ghost-secondary mb-2 mb-sm-0" data-hs-step-form-prev-options='{
                      "targetSelector": "#addUserStepBillingAddress"
                        }'>
                      <i class="bi-chevron-left"></i> Voltar
                    </button>

                    <div class="ms-auto">
                      <button id="botaoHabilitar" disabled type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#previewBoletos" data-acordo-id="">Ver boleto</button>
                    </div>
                  </div>
                  <!-- End Footer -->
                </div>
              </div>
              <!-- End Content Step Form -->
            </div>
          </div>
        </div>
      </form>
      <!-- End Step Form -->
    </div>
  </main>
<!-- ========== END MAIN CONTENT ========== -->

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cpfField = document.querySelector('input[name="cpf"]');
    const nextButton = document.getElementById('nextButton');
    const selectContainer = document.getElementById('addUserStepBillingAddress').querySelector('.col-sm-9 .mb-4');
    const nextButton2 = document.getElementById('nextButton2');
    const selectedContractsSpan = document.getElementById('selectedContracts');
    const selectedContractsSpan2 = document.getElementById('selectedContracts2');
    const contratosError = document.getElementById('contratosError');
    const pessoaCpfSpan = document.getElementById('pessoaCpf');
    const pessoaCpfSpan2 = document.getElementById('pessoaCpf2');
    const pessoaNomeSpan = document.getElementById('pessoaNome');
    const valorPendenteSpan = document.getElementById('valorPendente');
    const maiorDescontoSpan = document.getElementById('maiorDesconto');
    const menorDescontoSpan = document.getElementById('menorDesconto');
    const minParcelasSpan = document.getElementById('minParcelas');   
    const maxParcelasSpan = document.getElementById('maxParcelas');
    let apiResponse;

    cpfField.addEventListener('change', function() {
        let selectElement = selectContainer.querySelector('select');
        if (selectElement) {
            selectElement.remove();
        }
    });

    nextButton.addEventListener('click', function(e) {
        e.preventDefault();

        var cpf = cpfField.value.replace(/\D/g, '');
        var spinner = this.querySelector('.spinner-border');
        var cpfError = document.getElementById('cpfError');

        spinner.style.display = 'inline-block';

        fetch('/verificar-cpf/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cpf: cpf })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            spinner.style.display = 'none';

            if (data.result.length === 0) {
                cpfField.style.borderColor = '#E02B1D';
                cpfError.style.display = 'block';
            } else {
                apiResponse = data;
                cpfField.style.borderColor = '';
                cpfError.style.display = 'none';
                document.querySelector('#addUserStepFormProgress .step-item:nth-child(2) a').click();
                fillContractSelect(data.result[0].contratos);
                const pessoa = data.result[0].pessoa;
                pessoaCpfSpan.textContent = pessoa.cpf;
                pessoaCpfSpan2.textContent = pessoa.cpf;
                pessoaNomeSpan.textContent = pessoa.nome;
            }
        })
        .catch(error => {
            console.error('Erro ao verificar o CPF:', error);
            spinner.style.display = 'none';
        });
    });

    function fillContractSelect(contratos) {
      const selectContainer = document.getElementById('addUserStepBillingAddress').querySelector('.col-sm-9 .mb-4');

      while (selectContainer.firstChild) {
          selectContainer.removeChild(selectContainer.firstChild);
      }

      let selectElement = document.createElement('select');
      selectElement.id = 'contractSelect';
      selectElement.setAttribute('multiple', 'multiple');
      selectElement.className = 'form-control';
      selectContainer.appendChild(selectElement);

      const groupedContratos = contratos.reduce((acc, contrato) => {
          (acc[contrato.nomeCarteira] = acc[contrato.nomeCarteira] || []).push(contrato);
          return acc;
      }, {});

      Object.keys(groupedContratos).forEach(carteira => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = carteira;
          groupedContratos[carteira].forEach(contrato => {
              const option = document.createElement('option');
              option.value = contrato.numeroContrato;
              option.text = contrato.numeroContrato;
              optgroup.appendChild(option);
          });
          selectElement.appendChild(optgroup);
      });

      $(selectElement).select2({
          placeholder: "Selecione um contrato",
          allowClear: true
      });

      $(selectElement).on('select2:select', function (e) {
          const selectedCarteira = e.params.data.element.parentElement.label;
          $(selectElement).find('optgroup').not(`[label="${selectedCarteira}"]`).prop('disabled', true);
          $(selectElement).select2();
      });

      $(selectElement).on('select2:unselect', function () {
          if ($(selectElement).select2('data').length === 0) {
              $(selectElement).find('optgroup').prop('disabled', false);
              $(selectElement).select2();
          }
      });
    }

    nextButton2.addEventListener('click', function(e) {
        const selectElement = document.getElementById('contractSelect');
        const selectedOptions = Array.from(selectElement.selectedOptions).map(option => option.value);

        if (selectedOptions.length === 0) {
            e.preventDefault();
            selectElement.style.borderColor = '#E02B1D';
            contratosError.style.display = 'block';
        } else {
            selectedContractsSpan.textContent = selectedOptions.join(', ');
            selectedContractsSpan2.textContent = selectedOptions.join(', ');
            selectElement.style.borderColor = '';
            contratosError.style.display = 'none';
            document.querySelector('#addUserStepFormProgress .step-item:nth-child(3) a').click();
            logDiscounts(selectedOptions);
        }
    });

    function logDiscounts(selectedContracts) {
      if (!apiResponse) {
          console.error('API response is not defined');
          return;
      }

      const contratos = apiResponse.result[0].contratos;
      const descontos = apiResponse.result[0].descontos;
      let valorPendenteAmortizacao = 0;
      let maiorDesconto = 0;
      let menorDesconto = 100;
      let minParcelas = Infinity;
      let maxParcelas = 0;

      selectedContracts.forEach(contractNumber => {
          const contrato = contratos.find(c => c.numeroContrato === contractNumber);
          if (contrato) {
              valorPendenteAmortizacao += contrato.saldoAPagar;

              const contractDiscounts = descontos[contractNumber];
              contractDiscounts.forEach(desconto => {
                  if (desconto.pct_desconto > maiorDesconto) maiorDesconto = desconto.pct_desconto;
                  if (desconto.pct_desconto < menorDesconto) menorDesconto = desconto.pct_desconto;
                  if (desconto.qtd_parcelas < minParcelas) minParcelas = desconto.qtd_parcelas;
                  if (desconto.qtd_parcelas > maxParcelas) maxParcelas = desconto.qtd_parcelas;
              });
          }
      });

      console.log({ valorPendenteAmortizacao, maiorDesconto, menorDesconto, minParcelas, maxParcelas });

      valorPendenteSpan.textContent = 'R$ ' + valorPendenteAmortizacao.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
      maiorDescontoSpan.textContent = maiorDesconto + '%';
      menorDescontoSpan.textContent = menorDesconto + '%';

      const rangeInput = document.getElementById('customRange1');
      const textInput = document.getElementById('parcelasInput');
      rangeInput.min = minParcelas.toString();
      rangeInput.max = maxParcelas.toString();
      rangeInput.value = minParcelas.toString();
      textInput.value = minParcelas.toString();

      minParcelasSpan.textContent = minParcelas;
      maxParcelasSpan.textContent = maxParcelas;

      rangeInput.addEventListener('input', function() {
        textInput.value = rangeInput.value;
        atualizarValorParcela();
      });

      document.getElementById('Valor_do_Acordo').addEventListener('input', function(e) {
        let valor = this.value.replace(/[\D]/g, '');
        valor = (valor / 100).toFixed(2);
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+\,)/g, '$1.');
        
        this.value = valor;

        atualizarValorParcela();
      });

      function atualizarValorParcela() {
        const valor_do_acordo = parseFloat(document.getElementById('Valor_do_Acordo').value.replace(/\./g, '').replace(',', '.') || 0);
        const numParcelas = parseInt(document.getElementById('parcelasInput').value);
        const valor_parcela = valor_do_acordo / numParcelas;

        document.getElementById('valor_parcela').value = valor_parcela.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
      }

      minParcelasSpan.textContent = minParcelas;
      maxParcelasSpan.textContent = maxParcelas;

      const discounts = selectedContracts.reduce((acc, contractNumber) => {
          const contractDiscounts = apiResponse.result[0].descontos[contractNumber];
          if (contractDiscounts) {
              acc[contractNumber] = contractDiscounts;
          }
          return acc;
      }, {});

      console.log({ descontos: discounts });
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var firstDatePicker = flatpickr("#primeiroVencimentoFlatpickrInput", {
        dateFormat: "d/m/Y",
        minDate: "today",
        maxDate: new Date().setDate(new Date().getDate() + 5),
        onChange: function(selectedDates, dateStr, instance) {
            var proximoVencimentoSelect = document.getElementById('proximovencimentoFlatpickrInput');
            proximoVencimentoSelect.innerHTML = ''; // Limpar as opções existentes

            var dataSelecionada = selectedDates[0];
            var proximoMes = new Date(dataSelecionada);
            proximoMes.setMonth(proximoMes.getMonth() + 1);

            var diaSelecionado = dataSelecionada.getDate();
            var diasHabilitados = [];

            if (diaSelecionado >= 6 && diaSelecionado <= 10) {
                diasHabilitados = [5, 10, 15];
            } else if (diaSelecionado >= 11 && diaSelecionado <= 15) {
                diasHabilitados = [10, 15, 20];
            } else if (diaSelecionado >= 16 && diaSelecionado <= 20) {
                diasHabilitados = [15, 20, 25];
            } else if (diaSelecionado >= 21 && diaSelecionado <= 25) {
                diasHabilitados = [20, 25, 30];
            } else if (diaSelecionado >= 26 && diaSelecionado <= 31) {
                diasHabilitados = [5, 25, 30];
            } else {
                diasHabilitados = [5, 10, 15, 20, 25, 30];
            }

            diasHabilitados.forEach(function(dia) {
                var proximoVencimento = new Date(proximoMes.getFullYear(), proximoMes.getMonth(), dia);
                var option = document.createElement('option');
                option.value = proximoVencimento.toISOString().slice(0, 10); // Formato ISO: YYYY-MM-DD
                option.textContent = ('0' + dia).slice(-2) + '/' + ('0' + (proximoMes.getMonth() + 1)).slice(-2);
                proximoVencimentoSelect.appendChild(option);
            });
        }
    });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const valorDoAcordoInput = document.getElementById('Valor_do_Acordo');
    const valorPendenteSpan = document.getElementById('valorPendente');
    const valorAcordoError = document.getElementById('valorAcordoError');
    const parcelasInput = document.getElementById('parcelasInput');
    const primeiroVencimentoInput = document.getElementById('primeiroVencimentoFlatpickrInput');
    const proximoVencimentoInput = document.getElementById('proximovencimentoFlatpickrInput');
    const emailInput = document.getElementById('email');
    const telefoneInput = document.getElementById('PhoneNumberLabel');
    const preVisualizarAcordoBtn = document.getElementById('preVisualizarAcordoBtn');
    const aceitarAcordoBtn = document.getElementById('aceitarAcordoBtn');
    const botaoHabilitar = document.getElementById('botaoHabilitar');
    const tbody = document.getElementById('parcelasTBody');
    let parcelasGeradas = [];
    let acordoId = null;
    let simulacaoEnviada = false;
    let aceitacaoEnviada = false;


    function verificarCampos() {
      const todosPreenchidos = valorDoAcordoInput.value.trim() && parcelasInput.value.trim() && primeiroVencimentoInput.value.trim() && proximoVencimentoInput.value.trim() && emailInput.value.trim() && telefoneInput.value.trim();
      preVisualizarAcordoBtn.disabled = !todosPreenchidos;
    }

    [valorDoAcordoInput, parcelasInput, primeiroVencimentoInput, proximoVencimentoInput, emailInput, telefoneInput].forEach(input => {
      input.addEventListener('input', verificarCampos);
    });

    verificarCampos();

    function gerarParcelas() {
      const valorDoAcordo = parseFloat(valorDoAcordoInput.value.replace(/\./g, '').replace(',', '.') || 0);
      const numeroParcelas = parseInt(parcelasInput.value);
      const valorParcela = valorDoAcordo / numeroParcelas;
      const primeiraDataVencimento = primeiroVencimentoInput.value;
      const proximaDataVencimento = proximoVencimentoInput.value;

      parcelasGeradas = [];
      tbody.innerHTML = '';

      let dataVencimento = new Date(primeiraDataVencimento.split('/').reverse().join('-') + 'T00:00:00');
      let proximaData = new Date(proximaDataVencimento.split('/').reverse().join('-') + 'T00:00:00');

      for (let i = 1; i <= numeroParcelas; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <th scope="row">${i}</th>
            <td>R$ ${valorParcela.toFixed(2).replace('.', ',')}</td>
            <td>${dataVencimento.getDate().toString().padStart(2, '0')}/${(dataVencimento.getMonth() + 1).toString().padStart(2, '0')}/${dataVencimento.getFullYear()}</td>
        `;

        const parcela = {
              numero: `${i}`,
              valor: `${valorParcela.toFixed(2).replace('.', ',')}`,
              dataVencimento: `${dataVencimento.getDate().toString().padStart(2, '0')}/${(dataVencimento.getMonth() + 1).toString().padStart(2, '0')}/${dataVencimento.getFullYear()}`
          };
        
        parcelasGeradas.push(parcela);
        tbody.appendChild(tr);

        if (i === 1) {
            dataVencimento = new Date(proximaData.getTime());
        } else {
            dataVencimento.setMonth(dataVencimento.getMonth() + 1);
        }
      }
    }

    preVisualizarAcordoBtn.addEventListener('click', function() {
      const valorAcordoField = document.querySelector('input[name="Valor_do_Acordo"]');
      const valorDoAcordo = parseFloat(document.getElementById('Valor_do_Acordo').value.replace(/\./g, '').replace(',', '.') || 0);
      const valorPendente = parseFloat(document.getElementById('valorPendente').textContent.replace(/[^\d,]/g, '').replace(',', '.') || 0);

      if (valorDoAcordo < valorPendente) {
        const valorAcordoError = document.getElementById('valorAcordoError');
        valorAcordoField.style.borderColor = '#E02B1D';
        valorAcordoError.style.display = 'block';
        return;
      } else {
        const valorAcordoError = document.getElementById('valorAcordoError');
        valorAcordoField.style.borderColor = '';
        valorAcordoError.style.display = 'none'; 
        document.querySelector('#previewAcordo .modal-body span[id="valorAcordoSpan"]').textContent = valorDoAcordoInput.value;
        document.querySelector('#previewAcordo .modal-body span[id="numParcelasSpan"]').textContent = parcelasInput.value;
        document.querySelector('#previewAcordo .modal-body span[id="valorParcelaSpan"]').textContent = (parseFloat(valorDoAcordoInput.value.replace(/\./g, '').replace(',', '.') || 0) / parseInt(parcelasInput.value)).toFixed(2);
        document.querySelector('#previewAcordo .modal-body span[id="vencPrimeiraParcelaSpan"]').textContent = primeiroVencimentoInput.value;
        document.querySelector('#previewAcordo .modal-body span[id="vencProximasParcelasSpan"]').textContent = proximoVencimentoInput.value;
        document.querySelector('#previewAcordo .modal-body span[id="emailSpan"]').textContent = emailInput.value;
        document.querySelector('#previewAcordo .modal-body span[id="telefoneSpan"]').textContent = telefoneInput.value;
        gerarParcelas();

        var myModal = new bootstrap.Modal(document.getElementById('previewAcordo'));
        myModal.show();

        enviarDadosFormulario("Simulação");
      }
    });

    aceitarAcordoBtn.addEventListener('click', function() {
      if (acordoId) {
        enviarDadosFormulario("Aceito");
      }
    });
    
    botaoHabilitar.addEventListener('click', function() {
      const acordoId = this.getAttribute('data-acordo-id');
      fetch(`/detalhes-acordo/${acordoId}/`)
          .then(response => response.json())
          .then(acordo => {
              const parcelasTableBody = document.getElementById('parcelasBoleto');
              parcelasTableBody.innerHTML = '';
              acordo.parcelas.forEach((parcela, index) => {
                  const row = document.createElement('tr');
                  let buttonHTML = '';
                  if (index === 0) {
                      buttonHTML = `<button type="button" class="btn btn-warning btn-sm" style="width:100%;"><i class="bi bi-clipboard-plus-fill"></i> ver boleto</button>`;
                  } else {
                      buttonHTML = `<button type="button" class="btn btn-success btn-sm" style="width:100%;"><i class="bi bi-clipboard-data-fill"></i> gerar boleto</button>`;
                  }
                  row.innerHTML = `
                      <td>${parcela.numero}</td>
                      <td>${parcela.valor}</td>
                      <td>${parcela.dataVencimento}</td>
                      <td>${parcela.dataPagamento || '-'}</td>
                      <td>${parcela.situacao || 'REGULAR'}</td>
                      <td>${buttonHTML}</td>
                  `;
                  parcelasTableBody.appendChild(row);
              });
          });
    });

    function enviarDadosFormulario(status) {
      const cpf = document.querySelector('input[name="cpf"]').value;
      var cpfError = document.getElementById('cpfError');
      const selectedContracts = Array.from(document.getElementById('contractSelect').selectedOptions).map(option => option.value);
      const valor_do_acordo = valorDoAcordoInput.value;
      const numParcelas = parcelasInput.value;
      const valor_parcela = (parseFloat(valorDoAcordoInput.value.replace(/\./g, '').replace(',', '.') || 0) / parseInt(parcelasInput.value)).toFixed(2);
      const dia_vencimento_primeira_parcela = primeiroVencimentoInput.value;
      const dia_vencimento_proxima_parcela = proximoVencimentoInput.value;
      const email = emailInput.value;
      const telefone = telefoneInput.value;

      const formData = {
        acordoId,
        cpf,
        contratos: selectedContracts,
        valor_do_acordo,
        numParcelas,
        valor_parcela,
        parcelas: parcelasGeradas,
        dia_vencimento_primeira_parcela,
        dia_vencimento_proxima_parcela,
        email,
        telefone,
        status
      };

      if ((status === "Simulação" && simulacaoEnviada) || (status === "Aceito" && aceitacaoEnviada)) {
        console.log(`Formulário já enviado para ${status}.`);
        return;
      }

      fetch('{% url "salvar_acordo" %}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
          console.log('Info:', data);
          if (!acordoId && data.acordoId) {
              acordoId = data.acordoId;
          }
          if (status === "Aceito") {
              aceitacaoEnviada = true;
              botaoHabilitar.disabled = false;
              document.getElementById('botaoHabilitar').setAttribute('data-acordo-id', acordoId);
          } else if (status === "Simulação") {
              simulacaoEnviada = true;
          }
      })
      .catch((error) => {
          console.error('Erro:', error);
          alert('Erro ao salvar o acordo: ' + error.message);
      });
    }
  });
</script>

{% endblock %}