<!DOCTYPE html>
{% extends "t_base.html" %}
{% block content %}

<div class="container mt-4">
    <!-- Formulário de Busca -->
    <form action="{% url 't_listar_leads_banco' %}" method="GET" class="d-flex">
        <input type="text" class="form-control me-2" placeholder="Buscar por CPF" name="cpf_pesquisa" value="{{ cpf_pesquisa }}">
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    <!-- Tabela de Leads -->
    <div class="card mt-4">
        <div class="card-header">
            <h4 class="card-title">Leads</h4>
        </div>
        <div class="table-responsive">
            {% if leads %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>CPF</th>
                            <th>Nome</th>
                            <th>Empresa</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in leads %}
                            <tr>
                                <td><a href="{% url 'detalhes_lead' lead.cpf %}" class="text-primary">{{ lead.cpf }}</a></td>
                                <td>{{ lead.nome_completo|upper }}</td>
                                <td>{{ lead.empresa|default:"N/A" }}</td>
                                <td>
                                    <button 
                                        class="btn btn-danger btn-sm delete-lead" 
                                        data-cpf="{{ lead.cpf }}" 
                                        data-nome="{{ lead.nome_completo }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteLeadModal"
                                    >
                                        <i class="bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>                
                </table>
            {% else %}
                <p class="text-center m-3">Nenhum lead encontrado.</p>
            {% endif %}

            <!-- Modal de Confirmação de Exclusão -->
            <div class="modal fade" id="deleteLeadModal" tabindex="-1" aria-labelledby="deleteLeadModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteLeadModalLabel">Confirmar Exclusão</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <p>Tem certeza de que deseja excluir o lead?</p>
                            <p><strong>CPF:</strong> <span id="leadCpf"></span></p>
                            <p><strong>Nome:</strong> <span id="leadNome"></span></p>
                            <p class="text-danger">Esta ação é irreversível.</p>

                            <div class="mt-3" id="confirmCpfSection" style="display: none;">
                                <label for="confirmCpfInput" class="form-label">
                                    Para confirmar a exclusão, digite o CPF do lead: <strong id="cpfBold"></strong>
                                </label>
                                <input type="text" id="confirmCpfInput" class="form-control" placeholder="Digite o CPF">
                                <p id="cpfError" class="text-danger mt-2" style="display: none;">CPF incorreto. Tente novamente.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button id="confirmDeleteBtn" class="btn btn-danger" disabled>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <span class="delete-text">Excluir</span>
                            </button>                            
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedCpf = "";
        let deleteBtn = document.getElementById("confirmDeleteBtn");
        let confirmCpfSection = document.getElementById("confirmCpfSection");
        let confirmCpfInput = document.getElementById("confirmCpfInput");
        let cpfError = document.getElementById("cpfError");

        document.querySelectorAll(".delete-lead").forEach(button => {
            button.addEventListener("click", function () {
                selectedCpf = this.getAttribute("data-cpf");
                const leadNome = this.getAttribute("data-nome");
                document.getElementById("leadCpf").innerText = selectedCpf;
                document.getElementById("leadNome").innerText = leadNome;
                document.getElementById("cpfBold").innerText = selectedCpf;
                confirmCpfSection.style.display = "none";
                confirmCpfInput.value = "";
                deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span> <span class="delete-text">Excluir</span>';
                deleteBtn.disabled = false;
            });
        });

        deleteBtn.addEventListener("click", function () {
            if (deleteBtn.innerText === "Excluir") {
                deleteBtn.disabled = true;
                confirmCpfSection.style.display = "block";
                cpfError.style.display = "none";
                let count = 5;
                deleteBtn.innerHTML = `<span id="deleteTimer">${count}</span> Excluir`;
                let timerInterval = setInterval(() => {
                    count--;
                    document.getElementById("deleteTimer").innerText = count;
                    deleteBtn.disabled = true;
                    if (count === 0) {
                        clearInterval(timerInterval);
                        deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span> <span class="delete-text">Confirmar Exclusão</span>';
                        deleteBtn.disabled = true;
                    }
                }, 1000);
            }
        });

        confirmCpfInput.addEventListener("input", function () {
            if (confirmCpfInput.value === selectedCpf) {
                deleteBtn.disabled = false;
                cpfError.style.display = "none";
            } else {
                deleteBtn.disabled = true;
                cpfError.style.display = confirmCpfInput.value.length > 0 ? "block" : "none";
            }
        });

        deleteBtn.addEventListener("click", function () {
            if (deleteBtn.innerText.includes("Confirmar Exclusão") && confirmCpfInput.value === selectedCpf) {
                deleteBtn.disabled = true;
                deleteBtn.querySelector(".delete-text").innerText = "Excluindo...";
                deleteBtn.querySelector(".spinner-border").classList.remove("d-none");

                fetch(`/t/deletar_lead/${selectedCpf}/`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Lead excluído com sucesso!");
                        location.reload();
                    } else {
                        alert("Erro ao excluir o lead: " + data.error);
                        deleteBtn.disabled = false;
                        deleteBtn.querySelector(".delete-text").innerText = "Confirmar Exclusão";
                        deleteBtn.querySelector(".spinner-border").classList.add("d-none");
                    }
                })
                .catch(error => {
                    console.error("Erro ao excluir:", error);
                    deleteBtn.disabled = false;
                    deleteBtn.querySelector(".delete-text").innerText = "Confirmar Exclusão";
                    deleteBtn.querySelector(".spinner-border").classList.add("d-none");
                });
            }
        });
    });
</script>

{% endblock %}
